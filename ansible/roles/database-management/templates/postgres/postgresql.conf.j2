# jinja-shell
# ==============================================================================
# PostgreSQL 16 Configuration Template
# Ansible-managed file - DO NOT EDIT MANUALLY
# ==============================================================================

# Connection Settings
# ------------------------------------------------------------------------------
listen_addresses = '0.0.0.0'  # Docker internal - restricted by pg_hba.conf
port = 5432
max_connections = {{ POSTGRES_MAX_CONNECTIONS }}

# Authentication
# ------------------------------------------------------------------------------
password_encryption = scram-sha-256  # Secure password hashing

# Memory ConfiguratcReion (tuned for typical homelab with 8-16GB RAM)
# ------------------------------------------------------------------------------
shared_buffers = {{ POSTGRES_SHARED_BUFFERS }}  # 25% of RAM for database cache
effective_cache_size = {{ POSTGRES_EFFECTIVE_CACHE_SIZE }}  # 50-75% of RAM
work_mem = {{ POSTGRES_WORK_MEM }}  # Per-operation memory (sort, hash)
maintenance_work_mem = {{ POSTGRES_MAINTENANCE_WORK_MEM }}  # VACUUM, CREATE INDEX

# Write-Ahead Log (WAL) Configuration
# ------------------------------------------------------------------------------
wal_level = replica  # Enables point-in-time recovery and replication
max_wal_size = 2GB
min_wal_size = 1GB
wal_compression = on  # Reduces WAL disk usage

# Checkpoints (prevents I/O spikes)
# ------------------------------------------------------------------------------
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9

# Query Planning
# ------------------------------------------------------------------------------
random_page_cost = 1.1  # SSD-optimized (default 4.0 for spinning disks)
effective_io_concurrency = 200  # SSD concurrent I/O operations

# Logging Configuration
# ------------------------------------------------------------------------------
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_line_prefix = '%m [%p] %u@%d '
log_timezone = 'UTC'

# What to log
log_connections = on  # Track connection attempts
log_disconnections = on
log_duration = off
log_statement = 'ddl'  # Log DDL (CREATE, ALTER, DROP)
log_min_duration_statement = 1000  # Log queries > 1 second

# Autovacuum (automatic cleanup)
# ------------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 10min

# Lock Management
# ------------------------------------------------------------------------------
deadlock_timeout = 1s
max_locks_per_transaction = 64

# Client Connection Defaults
# ------------------------------------------------------------------------------
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'

# Extension Configuration
# ------------------------------------------------------------------------------
shared_preload_libraries = 'pg_stat_statements'  # Query statistics
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# SSL/TLS Configuration (optional - controlled by POSTGRES_ENABLE_SSL variable)
# ------------------------------------------------------------------------------
{% if POSTGRES_ENABLE_SSL %}
ssl = on
ssl_cert_file = '/var/lib/postgresql/certs/server.crt'
ssl_key_file = '/var/lib/postgresql/certs/server.key'
ssl_ca_file = '/var/lib/postgresql/certs/ca.crt'
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'  # Strong ciphers only
ssl_prefer_server_ciphers = on
ssl_min_protocol_version = 'TLSv1.2'
{% else %}
ssl = off
{% endif %}

# Performance Monitoring
# ------------------------------------------------------------------------------
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# pgvector Configuration (extension-specific)
# ------------------------------------------------------------------------------
# No special configuration needed - pgvector uses standard indexes
# HNSW index build: SET maintenance_work_mem = '2GB' before CREATE INDEX
# IVFFlat list count: Recommended = rows / 1000 (set via CREATE INDEX)
