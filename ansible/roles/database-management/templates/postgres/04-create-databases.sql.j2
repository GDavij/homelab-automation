-- ==============================================================================
-- Database creation
-- ==============================================================================

{% for database in POSTGRES_DATABASES %}
{% set db_owner = database.owner | default('postgres') %}
{% set db_limit = database.connection_limit | default(-1) %}

DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = '{{ database.name }}') THEN
        EXECUTE format('CREATE DATABASE %I WITH OWNER = %I ENCODING = ''UTF8'' LC_COLLATE = ''en_US.utf8'' LC_CTYPE = ''en_US.utf8'' TEMPLATE = template0 CONNECTION LIMIT = %s',
                       '{{ database.name }}',
                       '{{ db_owner }}',
                       {{ db_limit }});
        RAISE NOTICE 'Created database: {{ database.name }}';
    ELSE
        RAISE NOTICE 'Database already exists: {{ database.name }}';
    END IF;
END
$$;

COMMENT ON DATABASE "{{ database.name }}" IS '{{ database.description | default("Application database") | replace("'", "''") }}';

{% endfor %}

SELECT 'Databases configured successfully' AS status;
