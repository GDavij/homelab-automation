# roles/ollama/files/docker-compose.yml
services:
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    
    # GPU Support - NVIDIA RTX 3060 12GB
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    # Expose on Tailscale for direct access from other machines
    ports:
      - "${TAILSCALE_BIND_ADDRESS}:11434:11434"
    
    volumes:
      # Persistent model storage
      - '${OLLAMA_MODELS_PATH}:/root/.ollama'
    
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - OLLAMA_HOST=0.0.0.0:11434
    
    # DNS Configuration - Use Pi-hole for DNS resolution
    dns:
      - 172.18.0.10  # Pi-hole
      - 8.8.8.8      # Fallback to Google DNS
    
    # Attach to self-hosted network for internal communication
    networks:
      - self-hosted
    
    healthcheck:
      test: ["CMD-SHELL", "ollama list || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  self-hosted:
    external: true
